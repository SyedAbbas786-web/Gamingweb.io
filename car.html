<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Racing Extreme</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: linear-gradient(to bottom, #0a1929, #1a2b3c);
            color: white;
            font-family: 'Courier New', monospace;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            touch-action: none;
            transition: background 0.5s ease;
        }

        body.light-mode {
            background: linear-gradient(to bottom, #87CEEB, #4682B4);
            color: #333;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: 2px solid #00ff00;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            z-index: 1000;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: rgba(0, 255, 0, 0.3);
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
        }

        body.light-mode .theme-toggle {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            border-color: #ff6600;
        }

        body.light-mode .theme-toggle:hover {
            background: rgba(255, 102, 0, 0.3);
            box-shadow: 0 0 15px rgba(255, 102, 0, 0.5);
        }

        .game-container {
            position: relative;
            border: 4px solid #00ff00;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.3);
            background: #000;
            margin-top: 20px;
            max-height: 90vh;
        }

        body.light-mode .game-container {
            border-color: #ff6600;
            box-shadow: 0 0 30px rgba(255, 102, 0, 0.3);
        }

        canvas {
            display: block;
            background: #000;
            cursor: pointer;
        }

        body.light-mode canvas {
            background: linear-gradient(to bottom, #2c3e50, #34495e);
        }

        /* Enhanced Menu Screens */
        .menu-screen, .game-over-screen, .level-select-screen, .pause-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            z-index: 100;
            backdrop-filter: blur(10px);
            animation: menuAppear 0.5s ease-out;
        }

        @keyframes menuAppear {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        body.light-mode .menu-screen,
        body.light-mode .game-over-screen,
        body.light-mode .level-select-screen,
        body.light-mode .pause-screen {
            background: rgba(255, 255, 255, 0.95);
        }

        /* Racing Track Background for Menus */
        .menu-background {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
        }

        .road-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #ffff00, transparent);
            animation: roadMove 1s linear infinite;
        }

        @keyframes roadMove {
            from { transform: translateY(-100%); }
            to { transform: translateY(100%); }
        }

        /* Enhanced Title */
        .title {
            color: #00ff00;
            font-size: clamp(32px, 6vw, 48px);
            margin-bottom: 10px;
            text-shadow: 0 0 10px #00ff00, 0 0 20px #00ff00;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            letter-spacing: 2px;
            text-transform: uppercase;
            position: relative;
            padding-bottom: 10px;
        }

        .title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 3px;
            background: linear-gradient(90deg, transparent, #00ff00, transparent);
            animation: titleGlow 2s ease-in-out infinite;
        }

        @keyframes titleGlow {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        body.light-mode .title {
            color: #ff6600;
            text-shadow: 0 0 10px #ff6600, 0 0 20px #ff6600;
        }

        body.light-mode .title::after {
            background: linear-gradient(90deg, transparent, #ff6600, transparent);
        }

        .subtitle {
            color: #ffff00;
            font-size: clamp(16px, 3vw, 20px);
            margin-bottom: 40px;
            font-family: 'Courier New', monospace;
            animation: subtitlePulse 3s ease-in-out infinite;
        }

        @keyframes subtitlePulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        body.light-mode .subtitle {
            color: #ff9900;
        }

        /* Enhanced Buttons */
        .btn {
            background: linear-gradient(145deg, #00cc00, #00ff00);
            color: #000;
            border: none;
            padding: 15px 30px;
            font-size: clamp(14px, 2.5vw, 18px);
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px;
            font-family: 'Courier New', monospace;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            width: 220px;
            max-width: 80vw;
            position: relative;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 255, 0, 0.3);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            background: linear-gradient(145deg, #00ff00, #ffff00);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 255, 0, 0.5);
        }

        .btn:active {
            transform: translateY(1px);
            box-shadow: 0 3px 10px rgba(0, 255, 0, 0.3);
        }

        body.light-mode .btn {
            background: linear-gradient(145deg, #ff5500, #ff6600);
            color: white;
            box-shadow: 0 5px 15px rgba(255, 102, 0, 0.3);
        }

        body.light-mode .btn:hover {
            background: linear-gradient(145deg, #ff6600, #ff9900);
            box-shadow: 0 8px 20px rgba(255, 102, 0, 0.5);
        }

        body.light-mode .btn:active {
            box-shadow: 0 3px 10px rgba(255, 102, 0, 0.3);
        }

        .btn-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin: 30px 0;
        }

        .level-btn {
            background: linear-gradient(145deg, #0000cc, #0000ff);
            box-shadow: 0 5px 15px rgba(0, 0, 255, 0.3);
        }

        .level-btn:hover {
            background: linear-gradient(145deg, #0000ff, #00ffff);
            box-shadow: 0 8px 20px rgba(0, 0, 255, 0.5);
        }

        body.light-mode .level-btn {
            background: linear-gradient(145deg, #0066cc, #0088ff);
        }

        .btn-danger {
            background: linear-gradient(145deg, #cc0000, #ff0000);
            box-shadow: 0 5px 15px rgba(255, 0, 0, 0.3);
        }

        .btn-danger:hover {
            background: linear-gradient(145deg, #ff0000, #ff5555);
            box-shadow: 0 8px 20px rgba(255, 0, 0, 0.5);
        }

        body.light-mode .btn-danger {
            background: linear-gradient(145deg, #ff3333, #ff5555);
        }

        .btn-resume {
            background: linear-gradient(145deg, #00cc00, #00ff00);
            animation: resumePulse 2s infinite;
        }

        @keyframes resumePulse {
            0%, 100% { transform: translateY(-3px); }
            50% { transform: translateY(-6px); }
        }

        /* Stats Display */
        .stats-container {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            background: rgba(0, 0, 0, 0.5);
            padding: 15px 25px;
            border-radius: 10px;
            border: 2px solid #00ff00;
            backdrop-filter: blur(5px);
        }

        body.light-mode .stats-container {
            background: rgba(255, 255, 255, 0.5);
            border-color: #ff6600;
        }

        .stat-box {
            text-align: center;
            min-width: 100px;
        }

        .stat-label {
            color: #00ff00;
            font-size: 14px;
            margin-bottom: 5px;
        }

        body.light-mode .stat-label {
            color: #ff6600;
        }

        .stat-value {
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        body.light-mode .stat-value {
            color: #333;
        }

        /* Game UI Elements */
        .ui-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
            z-index: 20;
        }

        .ui-panel {
            background: rgba(0, 0, 0, 0.8);
            padding: 8px 16px;
            border: 2px solid #00ff00;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            backdrop-filter: blur(5px);
        }

        body.light-mode .ui-panel {
            background: rgba(255, 255, 255, 0.9);
            border-color: #ff6600;
            color: #333;
        }

        .ui-title {
            color: #00ff00;
            font-size: 12px;
            margin-bottom: 2px;
        }

        body.light-mode .ui-title {
            color: #ff6600;
        }

        .ui-value {
            color: white;
            font-size: 20px;
        }

        body.light-mode .ui-value {
            color: #333;
        }

        .boost-bar {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 20px;
            border: 2px solid #0000ff;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 3px;
            overflow: hidden;
            backdrop-filter: blur(5px);
            z-index: 20;
        }

        body.light-mode .boost-bar {
            border-color: #0066ff;
            background: rgba(255, 255, 255, 0.8);
        }

        .boost-fill {
            height: 100%;
            background: linear-gradient(to right, #0000ff, #00ffff);
            width: 0%;
            transition: width 0.1s;
        }

        body.light-mode .boost-fill {
            background: linear-gradient(to right, #0066ff, #00aaff);
        }

        .lives-display {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 5px;
            z-index: 20;
        }

        .life {
            width: 20px;
            height: 20px;
            background: #ff0000;
            border: 2px solid #ff5555;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        body.light-mode .life {
            background: #ff3333;
            border-color: #ff6666;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .car-highlight {
            position: absolute;
            border: 2px dashed #00ff00;
            border-radius: 5px;
            pointer-events: none;
            animation: highlight 2s infinite;
            display: none;
            z-index: 5;
        }

        body.light-mode .car-highlight {
            border-color: #ff6600;
        }

        @keyframes highlight {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .level-indicator {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: #00ff00;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            backdrop-filter: blur(5px);
            z-index: 20;
        }

        body.light-mode .level-indicator {
            background: rgba(255, 255, 255, 0.9);
            color: #ff6600;
        }

        .powerup-indicator {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: #ffff00;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            backdrop-filter: blur(5px);
            display: none;
            z-index: 20;
        }

        body.light-mode .powerup-indicator {
            background: rgba(255, 255, 255, 0.9);
            color: #ff9900;
        }

        .touch-instruction {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #00ffff;
            font-size: 14px;
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 5px;
            backdrop-filter: blur(5px);
            display: none;
            z-index: 20;
        }

        body.light-mode .touch-instruction {
            background: rgba(255, 255, 255, 0.9);
            color: #0066ff;
        }

        .hidden {
            display: none !important;
        }

        /* Car Animation in Menu */
        .menu-car {
            width: 60px;
            height: 100px;
            background: linear-gradient(145deg, #ff0000, #cc0000);
            position: absolute;
            bottom: -100px;
            border-radius: 5px;
            animation: driveIn 1s ease-out forwards;
        }

        @keyframes driveIn {
            to { bottom: 50px; }
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .game-container {
                width: 95vw;
                height: 70vh;
            }
            
            canvas {
                width: 100% !important;
                height: 100% !important;
            }
            
            .touch-instruction {
                display: block;
            }
            
            .theme-toggle {
                top: 10px;
                right: 10px;
                padding: 6px 12px;
                font-size: 14px;
            }
            
            .stats-container {
                flex-direction: column;
                gap: 10px;
                padding: 10px 15px;
            }
            
            .btn-group {
                gap: 10px;
            }
        }

        @media (min-width: 769px) {
            .game-container {
                width: 480px;
                height: 640px;
            }
        }
    </style>
</head>
<body>
    <!-- Theme Toggle Button -->
    <button class="theme-toggle" id="themeToggle">üåô Dark Mode</button>

    <div class="game-container">
        <canvas id="gameCanvas"></canvas>
        
        <!-- Touch highlight for car -->
        <div class="car-highlight" id="carHighlight"></div>
        
        <!-- UI Overlay -->
        <div class="ui-overlay">
            <div class="ui-panel">
                <div class="ui-title">SCORE</div>
                <div class="ui-value" id="score">00000</div>
            </div>
            <div class="ui-panel">
                <div class="ui-title">HIGH SCORE</div>
                <div class="ui-value" id="highScore">00000</div>
            </div>
        </div>

        <!-- Level Indicator -->
        <div class="level-indicator" id="levelIndicator">LEVEL: EASY</div>

        <!-- Power-up Indicator -->
        <div class="powerup-indicator" id="powerupIndicator"></div>

        <!-- Boost Bar -->
        <div class="boost-bar">
            <div class="boost-fill" id="boostFill"></div>
        </div>

        <!-- Lives Display -->
        <div class="lives-display" id="livesDisplay"></div>

        <!-- Touch Instruction -->
        <div class="touch-instruction" id="touchInstruction">Drag car to move | Tap anywhere to pause</div>

        <!-- Main Menu Screen -->
        <div class="menu-screen" id="menuScreen">
            <div class="menu-background">
                <div class="road-line" style="left: 25%; animation-delay: 0s;"></div>
                <div class="road-line" style="left: 50%; animation-delay: 0.2s;"></div>
                <div class="road-line" style="left: 75%; animation-delay: 0.4s;"></div>
            </div>
            
            <h1 class="title">CAR RACING EXTREME</h1>
            <p class="subtitle">Survive as long as you can!</p>
            
            <div class="stats-container">
                <div class="stat-box">
                    <div class="stat-label">HIGH SCORE</div>
                    <div class="stat-value" id="menuHighScore">00000</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">LEVELS</div>
                    <div class="stat-value">3</div>
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn" id="playBtn">üöÄ PLAY GAME</button>
                <button class="btn level-btn" id="continueBtn">‚ñ∂Ô∏è CONTINUE</button>
                <button class="btn" id="instructionsBtn">‚ùì HOW TO PLAY</button>
            </div>
            
            <div class="menu-car"></div>
        </div>

        <!-- Pause Screen -->
        <div class="pause-screen hidden" id="pauseScreen">
            <div class="menu-background">
                <div class="road-line" style="left: 25%; animation-delay: 0s;"></div>
                <div class="road-line" style="left: 50%; animation-delay: 0.2s;"></div>
                <div class="road-line" style="left: 75%; animation-delay: 0.4s;"></div>
            </div>
            
            <h1 class="title">GAME PAUSED</h1>
            <p class="subtitle">Take a breather, racer!</p>
            
            <div class="stats-container">
                <div class="stat-box">
                    <div class="stat-label">SCORE</div>
                    <div class="stat-value" id="pauseScore">00000</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">LIVES</div>
                    <div class="stat-value" id="pauseLives">3</div>
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-resume" id="resumeBtn">‚ñ∂Ô∏è RESUME GAME</button>
                <button class="btn" id="pauseInstructionsBtn">‚ùì HOW TO PLAY</button>
                <button class="btn btn-danger" id="pauseMenuBtn">üè† MAIN MENU</button>
            </div>
        </div>

        <!-- Level Select Screen -->
        <div class="level-select-screen hidden" id="levelSelectScreen">
            <div class="menu-background">
                <div class="road-line" style="left: 25%; animation-delay: 0s;"></div>
                <div class="road-line" style="left: 50%; animation-delay: 0.2s;"></div>
                <div class="road-line" style="left: 75%; animation-delay: 0.4s;"></div>
            </div>
            
            <h1 class="title">SELECT LEVEL</h1>
            <p class="subtitle">Choose your challenge</p>
            
            <div class="btn-group">
                <button class="btn level-btn" data-level="easy">
                    üòä EASY<br>
                    <small style="font-size: 12px; opacity: 0.8;">Normal speed, more space</small>
                </button>
                <button class="btn level-btn" data-level="hard">
                    üòé HARD<br>
                    <small style="font-size: 12px; opacity: 0.8;">Faster obstacles</small>
                </button>
                <button class="btn level-btn" data-level="extreme">
                    üî• EXTREME<br>
                    <small style="font-size: 12px; opacity: 0.8;">Extreme speed, less space</small>
                </button>
            </div>
            
            <button class="btn btn-danger" id="backBtn">‚Üê BACK</button>
        </div>

        <!-- Game Over Screen -->
        <div class="game-over-screen hidden" id="gameOverScreen">
            <div class="menu-background">
                <div class="road-line" style="left: 25%; animation-delay: 0s;"></div>
                <div class="road-line" style="left: 50%; animation-delay: 0.2s;"></div>
                <div class="road-line" style="left: 75%; animation-delay: 0.4s;"></div>
            </div>
            
            <h1 class="title">GAME OVER</h1>
            <p class="subtitle" id="finalScoreText">SCORE: 00000</p>
            
            <div class="stats-container">
                <div class="stat-box">
                    <div class="stat-label">SCORE</div>
                    <div class="stat-value" id="finalScore">00000</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">HIGH SCORE</div>
                    <div class="stat-value" id="finalHighScore">00000</div>
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn" id="restartBtn">üîÑ PLAY AGAIN</button>
                <button class="btn btn-danger" id="gameOverMenuBtn">üè† MAIN MENU</button>
            </div>
        </div>
    </div>

    <script>
        class ExtremeCarRacingGame {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                
                // Set canvas size based on screen
                this.setCanvasSize();
                
                // Game settings
                this.level = 'easy';
                this.levelSpeeds = {
                    easy: { player: 4, obstacle: 5, nitro: 3 },
                    hard: { player: 6, obstacle: 7, nitro: 4 },
                    extreme: { player: 8, obstacle: 9, nitro: 5 }
                };
                
                // Game state
                this.state = 'menu';
                this.score = 0;
                this.highScore = parseInt(localStorage.getItem('carRacingExtremeHighScore')) || 0;
                this.lives = 3;
                this.gameTime = 0;
                
                // Player car
                this.car = {
                    x: this.canvas.width / 2 - 15,
                    y: this.canvas.height - 120,
                    width: 30,
                    height: 60,
                    targetX: this.canvas.width / 2 - 15,
                    velocityX: 0,
                    acceleration: 0.5,
                    friction: 0.2,
                    rotation: 0,
                    maxRotation: 0.3,
                    isDragging: false,
                    dragOffsetX: 0,
                    speed: 4
                };
                
                // Obstacles
                this.obstacles = [];
                this.maxObstacles = 5;
                this.obstacleTypes = [
                    { width: 30, height: 60, color: '#ff0000' },
                    { width: 35, height: 70, color: '#ff6600' },
                    { width: 40, height: 80, color: '#ff0000' }
                ];
                
                // Power-ups
                this.powerups = [];
                this.maxPowerups = 2;
                this.activePowerup = null;
                this.powerupTimer = 0;
                this.powerupTypes = {
                    nitro: { color: '#0000ff', symbol: '‚ö°', duration: 300, effect: 'speed' },
                    shield: { color: '#00ff00', symbol: 'üõ°Ô∏è', duration: 400, effect: 'invincible' },
                    slowmo: { color: '#ffff00', symbol: '‚è±Ô∏è', duration: 350, effect: 'slow' },
                    coin: { color: '#ffd700', symbol: 'üí∞', duration: 0, effect: 'score' }
                };
                
                // Game objects pools
                this.particles = [];
                this.sparks = [];
                
                // Road animation
                this.roadOffset = 0;
                this.sideRoadOffset = 0;
                
                // Touch controls
                this.touchStartX = 0;
                this.touchStartY = 0;
                this.lastTouchTime = 0;
                
                // Game state backup for pause
                this.pausedState = null;
                
                // Initialize
                this.init();
            }
            
            setCanvasSize() {
                const container = document.querySelector('.game-container');
                this.canvas.width = container.clientWidth;
                this.canvas.height = container.clientHeight;
                
                if (this.car) {
                    this.car.x = this.canvas.width / 2 - this.car.width / 2;
                    this.car.y = this.canvas.height - 120;
                    this.car.targetX = this.car.x;
                }
            }
            
            init() {
                this.setupEventListeners();
                this.updateMenuStats();
                this.gameLoop();
                this.setupTheme();
            }
            
            setupEventListeners() {
                // Theme toggle
                document.getElementById('themeToggle').addEventListener('click', () => this.toggleTheme());
                
                // Menu buttons
                document.getElementById('playBtn').addEventListener('click', () => this.showLevelSelect());
                document.getElementById('continueBtn').addEventListener('click', () => {
                    if (this.pausedState) {
                        this.resumeGame();
                    } else {
                        this.showLevelSelect();
                    }
                });
                document.getElementById('instructionsBtn').addEventListener('click', () => this.showInstructions());
                document.getElementById('backBtn').addEventListener('click', () => this.showMenu());
                
                // Level buttons
                document.querySelectorAll('.level-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const level = e.target.dataset.level;
                        this.startGame(level);
                    });
                });
                
                // Pause screen buttons
                document.getElementById('resumeBtn').addEventListener('click', () => this.resumeGame());
                document.getElementById('pauseInstructionsBtn').addEventListener('click', () => this.showInstructions());
                document.getElementById('pauseMenuBtn').addEventListener('click', () => this.showMenu());
                
                // Game over buttons
                document.getElementById('restartBtn').addEventListener('click', () => this.restartGame());
                document.getElementById('gameOverMenuBtn').addEventListener('click', () => this.showMenu());
                
                // Keyboard controls
                document.addEventListener('keydown', (e) => {
                    if (this.state === 'menu' || this.state === 'levelselect' || this.state === 'gameover') return;
                    
                    switch(e.key.toLowerCase()) {
                        case 'arrowleft':
                        case 'a':
                            e.preventDefault();
                            this.startSteering(-1);
                            break;
                        case 'arrowright':
                        case 'd':
                            e.preventDefault();
                            this.startSteering(1);
                            break;
                        case 'arrowup':
                        case 'w':
                            e.preventDefault();
                            this.activateNitro();
                            break;
                        case 'p':
                        case ' ':
                            e.preventDefault();
                            this.togglePause();
                            break;
                        case 'escape':
                            if (this.state === 'playing') {
                                this.pauseGame();
                            } else if (this.state === 'paused') {
                                this.resumeGame();
                            }
                            break;
                    }
                });
                
                document.addEventListener('keyup', (e) => {
                    if (this.state !== 'playing') return;
                    
                    switch(e.key.toLowerCase()) {
                        case 'arrowleft':
                        case 'a':
                        case 'arrowright':
                        case 'd':
                            this.stopSteering();
                            break;
                    }
                });
                
                // Mouse and touch controls
                this.canvas.addEventListener('mousedown', (e) => this.handlePointerStart(e.clientX, e.clientY));
                this.canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    this.handlePointerStart(touch.clientX, touch.clientY);
                });
                
                this.canvas.addEventListener('mousemove', (e) => this.handlePointerMove(e.clientX, e.clientY));
                this.canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    this.handlePointerMove(touch.clientX, touch.clientY);
                });
                
                this.canvas.addEventListener('mouseup', () => this.handlePointerEnd());
                this.canvas.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.handlePointerEnd();
                });
                
                this.canvas.addEventListener('mouseleave', () => this.handlePointerEnd());
                
                // Double tap for pause on mobile
                this.canvas.addEventListener('touchend', (e) => {
                    const currentTime = Date.now();
                    if (currentTime - this.lastTouchTime < 300) {
                        this.togglePause();
                    }
                    this.lastTouchTime = currentTime;
                });
                
                // Window resize
                window.addEventListener('resize', () => {
                    this.setCanvasSize();
                    this.render();
                });
            }
            
            setupTheme() {
                const theme = localStorage.getItem('carRacingTheme') || 'dark';
                if (theme === 'light') {
                    document.body.classList.add('light-mode');
                    document.getElementById('themeToggle').textContent = '‚òÄÔ∏è Light Mode';
                }
            }
            
            toggleTheme() {
                document.body.classList.toggle('light-mode');
                if (document.body.classList.contains('light-mode')) {
                    localStorage.setItem('carRacingTheme', 'light');
                    document.getElementById('themeToggle').textContent = '‚òÄÔ∏è Light Mode';
                } else {
                    localStorage.setItem('carRacingTheme', 'dark');
                    document.getElementById('themeToggle').textContent = 'üåô Dark Mode';
                }
            }
            
            handlePointerStart(clientX, clientY) {
                const rect = this.canvas.getBoundingClientRect();
                const x = clientX - rect.left;
                const y = clientY - rect.top;
                
                // Check if touch is on car
                if (this.isPointOnCar(x, y)) {
                    this.car.isDragging = true;
                    this.car.dragOffsetX = x - this.car.x;
                    this.showCarHighlight();
                } else {
                    this.touchStartX = x;
                    this.touchStartY = y;
                    
                    // Quick tap to activate nitro
                    if (this.state === 'playing' && y < this.canvas.height - 100) {
                        this.activateNitro();
                    }
                }
            }
            
            handlePointerMove(clientX, clientY) {
                if (this.state !== 'playing') return;
                
                const rect = this.canvas.getBoundingClientRect();
                const x = clientX - rect.left;
                const y = clientY - rect.top;
                
                if (this.car.isDragging) {
                    const targetX = x - this.car.dragOffsetX;
                    this.car.targetX = this.clamp(targetX, 50, this.canvas.width - 50 - this.car.width);
                } else if (this.touchStartX) {
                    const dx = x - this.touchStartX;
                    if (Math.abs(dx) > 5) {
                        this.car.targetX += dx * 0.8;
                        this.car.targetX = this.clamp(this.car.targetX, 50, this.canvas.width - 50 - this.car.width);
                        this.touchStartX = x;
                    }
                }
            }
            
            handlePointerEnd() {
                this.car.isDragging = false;
                this.hideCarHighlight();
                this.touchStartX = 0;
                this.touchStartY = 0;
            }
            
            isPointOnCar(x, y) {
                return (
                    x >= this.car.x &&
                    x <= this.car.x + this.car.width &&
                    y >= this.car.y &&
                    y <= this.car.y + this.car.height
                );
            }
            
            showCarHighlight() {
                const highlight = document.getElementById('carHighlight');
                highlight.style.display = 'block';
                highlight.style.left = (this.car.x - 10) + 'px';
                highlight.style.top = (this.car.y - 10) + 'px';
                highlight.style.width = (this.car.width + 20) + 'px';
                highlight.style.height = (this.car.height + 20) + 'px';
            }
            
            hideCarHighlight() {
                document.getElementById('carHighlight').style.display = 'none';
            }
            
            startSteering(direction) {
                if (this.state !== 'playing') return;
                this.car.targetX += direction * 8;
                this.car.targetX = this.clamp(this.car.targetX, 50, this.canvas.width - 50 - this.car.width);
                this.car.rotation = direction * this.car.maxRotation;
            }
            
            stopSteering() {
                this.car.rotation = 0;
            }
            
            activateNitro() {
                if (this.state !== 'playing' || this.activePowerup === 'nitro') return;
                
                this.activePowerup = 'nitro';
                this.powerupTimer = this.powerupTypes.nitro.duration;
                this.showPowerupIndicator('NITRO BOOST!');
                this.createNitroEffect();
            }
            
            showInstructions() {
                alert(`üöó CAR RACING EXTREME - HOW TO PLAY üöó

üéÆ CONTROLS:
‚Ä¢ Arrow Keys / WASD: Steer Car
‚Ä¢ Mouse/Touch: Drag car to move
‚Ä¢ Space/P: Pause Game
‚Ä¢ ESC: Quit to Menu
‚Ä¢ Double Tap (Mobile): Pause

‚ö° POWER-UPS:
‚Ä¢ Blue ‚ö°: Nitro Boost (Temporary Speed)
‚Ä¢ Green üõ°Ô∏è: Shield (Invincibility)
‚Ä¢ Yellow ‚è±Ô∏è: Slow Motion (Slows Obstacles)
‚Ä¢ Gold üí∞: Bonus Points

üèÜ LEVELS:
‚Ä¢ EASY: Normal speed, more space
‚Ä¢ HARD: Faster obstacles
‚Ä¢ EXTREME: Extreme speed, less space

üí° TIPS:
‚Ä¢ Use smooth movements to dodge
‚Ä¢ Collect power-ups strategically
‚Ä¢ Watch for patterns in traffic
‚Ä¢ Higher levels = Higher scores!

Good luck, racer! üèÅ`);
            }
            
            updateMenuStats() {
                document.getElementById('menuHighScore').textContent = this.highScore.toString().padStart(5, '0');
                document.getElementById('pauseScore').textContent = this.score.toString().padStart(5, '0');
                document.getElementById('pauseLives').textContent = this.lives.toString();
            }
            
            showLevelSelect() {
                document.getElementById('menuScreen').classList.add('hidden');
                document.getElementById('levelSelectScreen').classList.remove('hidden');
                this.state = 'levelselect';
            }
            
            startGame(level) {
                this.level = level;
                const speeds = this.levelSpeeds[level];
                
                this.car.speed = speeds.player;
                this.car.acceleration = level === 'extreme' ? 0.7 : 0.5;
                
                this.score = 0;
                this.lives = 3;
                this.gameTime = 0;
                this.activePowerup = null;
                this.powerupTimer = 0;
                
                this.car.x = this.canvas.width / 2 - this.car.width / 2;
                this.car.y = this.canvas.height - 120;
                this.car.targetX = this.car.x;
                this.car.velocityX = 0;
                this.car.rotation = 0;
                
                this.obstacles = [];
                this.powerups = [];
                this.particles = [];
                this.sparks = [];
                
                for (let i = 0; i < this.maxObstacles; i++) {
                    this.spawnObstacle(-i * 200);
                }
                
                for (let i = 0; i < this.maxPowerups; i++) {
                    this.spawnPowerup(-i * 300 - 150);
                }
                
                this.updateUI();
                this.updateLivesDisplay();
                document.getElementById('levelIndicator').textContent = `LEVEL: ${level.toUpperCase()}`;
                document.getElementById('powerupIndicator').style.display = 'none';
                
                document.getElementById('levelSelectScreen').classList.add('hidden');
                document.getElementById('gameOverScreen').classList.add('hidden');
                document.getElementById('pauseScreen').classList.add('hidden');
                
                this.state = 'playing';
            }
            
            showMenu() {
                this.state = 'menu';
                document.getElementById('menuScreen').classList.remove('hidden');
                document.getElementById('levelSelectScreen').classList.add('hidden');
                document.getElementById('gameOverScreen').classList.add('hidden');
                document.getElementById('pauseScreen').classList.add('hidden');
                this.updateMenuStats();
            }
            
            togglePause() {
                if (this.state === 'playing') {
                    this.pauseGame();
                } else if (this.state === 'paused') {
                    this.resumeGame();
                }
            }
            
            pauseGame() {
                this.state = 'paused';
                this.updateMenuStats();
                document.getElementById('pauseScreen').classList.remove('hidden');
            }
            
            resumeGame() {
                this.state = 'playing';
                document.getElementById('pauseScreen').classList.add('hidden');
            }
            
            spawnObstacle(offsetY = 0) {
                const type = this.obstacleTypes[Math.floor(Math.random() * this.obstacleTypes.length)];
                const laneCount = Math.floor((this.canvas.width - 100) / (type.width + 20));
                const lane = Math.floor(Math.random() * laneCount);
                const laneWidth = (this.canvas.width - 100) / laneCount;
                
                this.obstacles.push({
                    x: 50 + lane * laneWidth + (laneWidth - type.width) / 2,
                    y: offsetY,
                    width: type.width,
                    height: type.height,
                    speed: this.levelSpeeds[this.level].obstacle + Math.random() * 2,
                    color: type.color,
                    type: 'obstacle'
                });
            }
            
            spawnPowerup(offsetY = 0) {
                const powerupKeys = Object.keys(this.powerupTypes);
                const typeKey = powerupKeys[Math.floor(Math.random() * powerupKeys.length)];
                const type = this.powerupTypes[typeKey];
                const laneCount = Math.floor((this.canvas.width - 100) / 50);
                const lane = Math.floor(Math.random() * laneCount);
                
                this.powerups.push({
                    x: 50 + lane * 50,
                    y: offsetY,
                    width: 40,
                    height: 40,
                    speed: this.levelSpeeds[this.level].nitro,
                    color: type.color,
                    symbol: type.symbol,
                    type: typeKey,
                    effect: type.effect,
                    duration: type.duration
                });
            }
            
            updateLivesDisplay() {
                const container = document.getElementById('livesDisplay');
                container.innerHTML = '';
                for (let i = 0; i < this.lives; i++) {
                    const life = document.createElement('div');
                    life.className = 'life';
                    container.appendChild(life);
                }
            }
            
            updateUI() {
                document.getElementById('score').textContent = this.score.toString().padStart(5, '0');
                document.getElementById('highScore').textContent = this.highScore.toString().padStart(5, '0');
            }
            
            updateBoostBar() {
                const fill = document.getElementById('boostFill');
                if (this.activePowerup === 'nitro') {
                    const percentage = (this.powerupTimer / this.powerupTypes.nitro.duration) * 100;
                    fill.style.width = percentage + '%';
                } else {
                    fill.style.width = '0%';
                }
            }
            
            showPowerupIndicator(text) {
                const indicator = document.getElementById('powerupIndicator');
                indicator.textContent = text;
                indicator.style.display = 'block';
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 1500);
            }
            
            checkCollision(obj1, obj2) {
                return (
                    obj1.x < obj2.x + obj2.width &&
                    obj1.x + obj1.width > obj2.x &&
                    obj1.y < obj2.y + obj2.height &&
                    obj1.y + obj1.height > obj2.y
                );
            }
            
            clamp(value, min, max) {
                return Math.max(min, Math.min(max, value));
            }
            
            gameLoop() {
                if (this.state === 'playing') {
                    this.update();
                }
                this.render();
                requestAnimationFrame(() => this.gameLoop());
            }
            
            update() {
                this.gameTime++;
                this.updateCarPosition();
                
                const roadSpeed = this.activePowerup === 'nitro' ? 1.5 : 1;
                this.roadOffset += (this.car.speed * roadSpeed) / 2;
                if (this.roadOffset >= 40) this.roadOffset = 0;
                this.sideRoadOffset += (this.car.speed * roadSpeed) / 4;
                if (this.sideRoadOffset >= 80) this.sideRoadOffset = 0;
                
                const obstacleSpeedMultiplier = this.activePowerup === 'slowmo' ? 0.5 : 1;
                
                for (let i = this.obstacles.length - 1; i >= 0; i--) {
                    const obs = this.obstacles[i];
                    obs.y += obs.speed * obstacleSpeedMultiplier;
                    
                    if (this.checkCollision(
                        {x: this.car.x, y: this.car.y, width: this.car.width, height: this.car.height},
                        obs
                    )) {
                        if (this.activePowerup === 'shield') {
                            this.createShieldEffect();
                        } else {
                            this.lives--;
                            this.updateLivesDisplay();
                            this.createCollisionEffect(obs.x + obs.width / 2, obs.y + obs.height / 2);
                            
                            if (this.lives <= 0) {
                                this.gameOver();
                                return;
                            }
                        }
                        
                        obs.y = -obs.height;
                        obs.x = 50 + Math.random() * (this.canvas.width - 100 - obs.width);
                        continue;
                    }
                    
                    if (obs.y > this.canvas.height) {
                        this.score += 10;
                        obs.y = -obs.height;
                        obs.x = 50 + Math.random() * (this.canvas.width - 100 - obs.width);
                        obs.speed = this.levelSpeeds[this.level].obstacle + Math.random() * 2;
                        
                        if (this.gameTime % 500 === 0) {
                            obs.speed += 0.5;
                        }
                    }
                }
                
                for (let i = this.powerups.length - 1; i >= 0; i--) {
                    const powerup = this.powerups[i];
                    powerup.y += powerup.speed;
                    
                    if (this.checkCollision(
                        {x: this.car.x, y: this.car.y, width: this.car.width, height: this.car.height},
                        powerup
                    )) {
                        this.activePowerup = powerup.type;
                        this.powerupTimer = powerup.duration;
                        
                        if (powerup.type === 'coin') {
                            this.score += 500;
                            this.showPowerupIndicator('+500 POINTS!');
                        } else {
                            this.showPowerupIndicator(`${powerup.symbol} ${powerup.type.toUpperCase()}!`);
                        }
                        
                        this.createPowerupEffect(powerup.x + powerup.width / 2, powerup.y + powerup.height / 2, powerup.color);
                        
                        powerup.y = -powerup.height;
                        powerup.x = 50 + Math.random() * (this.canvas.width - 100 - powerup.width);
                    }
                    
                    if (powerup.y > this.canvas.height) {
                        powerup.y = -powerup.height;
                        powerup.x = 50 + Math.random() * (this.canvas.width - 100 - powerup.width);
                    }
                }
                
                if (this.activePowerup && this.powerupTimer > 0) {
                    this.powerupTimer--;
                    if (this.powerupTimer <= 0) {
                        this.activePowerup = null;
                    }
                }
                
                this.updateParticles();
                this.updateUI();
                this.updateBoostBar();
                
                const spawnRate = this.level === 'extreme' ? 80 : this.level === 'hard' ? 100 : 120;
                if (this.gameTime % spawnRate === 0 && this.obstacles.length < this.maxObstacles) {
                    this.spawnObstacle();
                }
                
                if (this.gameTime % 300 === 0 && this.powerups.length < this.maxPowerups) {
                    this.spawnPowerup();
                }
            }
            
            updateCarPosition() {
                const dx = this.car.targetX - this.car.x;
                this.car.velocityX += dx * this.car.acceleration;
                this.car.velocityX *= (1 - this.car.friction);
                this.car.x += this.car.velocityX;
                
                const targetRotation = this.car.velocityX * 0.02;
                this.car.rotation += (targetRotation - this.car.rotation) * 0.1;
                
                this.car.x = this.clamp(this.car.x, 50, this.canvas.width - 50 - this.car.width);
            }
            
            createNitroEffect() {
                for (let i = 0; i < 20; i++) {
                    this.particles.push({
                        x: this.car.x + this.car.width / 2,
                        y: this.car.y + this.car.height,
                        vx: (Math.random() - 0.5) * 4,
                        vy: Math.random() * 8 + 4,
                        color: '#00ffff',
                        size: Math.random() * 3 + 2,
                        life: 30
                    });
                }
            }
            
            createShieldEffect() {
                for (let i = 0; i < 15; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const radius = Math.max(this.car.width, this.car.height) / 2;
                    this.sparks.push({
                        x: this.car.x + this.car.width / 2 + Math.cos(angle) * radius,
                        y: this.car.y + this.car.height / 2 + Math.sin(angle) * radius,
                        vx: Math.cos(angle) * 3,
                        vy: Math.sin(angle) * 3,
                        color: '#00ff00',
                        size: Math.random() * 4 + 2,
                        life: 40
                    });
                }
            }
            
            createCollisionEffect(x, y) {
                for (let i = 0; i < 25; i++) {
                    this.particles.push({
                        x: x,
                        y: y,
                        vx: (Math.random() - 0.5) * 10,
                        vy: (Math.random() - 0.5) * 10,
                        color: '#ff0000',
                        size: Math.random() * 6 + 3,
                        life: 50
                    });
                }
            }
            
            createPowerupEffect(x, y, color) {
                for (let i = 0; i < 20; i++) {
                    this.particles.push({
                        x: x,
                        y: y,
                        vx: (Math.random() - 0.5) * 6,
                        vy: (Math.random() - 0.5) * 6,
                        color: color,
                        size: Math.random() * 4 + 2,
                        life: 40
                    });
                }
            }
            
            updateParticles() {
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    const p = this.particles[i];
                    p.x += p.vx;
                    p.y += p.vy;
                    p.life--;
                    p.size *= 0.97;
                    
                    if (p.life <= 0) {
                        this.particles.splice(i, 1);
                    }
                }
                
                for (let i = this.sparks.length - 1; i >= 0; i--) {
                    const s = this.sparks[i];
                    s.x += s.vx;
                    s.y += s.vy;
                    s.life--;
                    s.size *= 0.96;
                    
                    if (s.life <= 0) {
                        this.sparks.splice(i, 1);
                    }
                }
            }
            
            gameOver() {
                this.state = 'gameover';
                
                if (this.score > this.highScore) {
                    this.highScore = this.score;
                    localStorage.setItem('carRacingExtremeHighScore', this.highScore);
                }
                
                document.getElementById('gameOverScreen').classList.remove('hidden');
                document.getElementById('finalScoreText').textContent = `SCORE: ${this.score.toString().padStart(5, '0')}`;
                document.getElementById('finalScore').textContent = this.score.toString().padStart(5, '0');
                document.getElementById('finalHighScore').textContent = this.highScore.toString().padStart(5, '0');
            }
            
            restartGame() {
                this.startGame(this.level);
            }
            
            render() {
                this.ctx.fillStyle = document.body.classList.contains('light-mode') ? '#2c3e50' : '#000';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                this.drawBackground();
                this.drawRoad();
                
                for (let obs of this.obstacles) {
                    this.drawObstacle(obs);
                }
                
                for (let powerup of this.powerups) {
                    this.drawPowerup(powerup);
                }
                
                this.drawParticles();
                this.drawSparks();
                this.drawPlayerCar();
                
                if (this.activePowerup === 'shield') {
                    this.drawShield();
                }
                
                if (this.activePowerup === 'nitro') {
                    this.drawNitroEffect();
                }
            }
            
            drawBackground() {
                const isLight = document.body.classList.contains('light-mode');
                this.ctx.fillStyle = isLight ? 'rgba(255, 255, 255, 0.1)' : 'rgba(255, 255, 255, 0.05)';
                
                for (let i = 0; i < 20; i++) {
                    const x = Math.random() * this.canvas.width;
                    const y = Math.random() * this.canvas.height * 0.3;
                    const size = Math.random() * 2 + 1;
                    this.ctx.beginPath();
                    this.ctx.arc(x, y, size, 0, Math.PI * 2);
                    this.ctx.fill();
                }
            }
            
            drawRoad() {
                const roadWidth = this.canvas.width - 100;
                const roadX = 50;
                const isLight = document.body.classList.contains('light-mode');
                
                const gradient = this.ctx.createLinearGradient(roadX, 0, roadX + roadWidth, 0);
                if (isLight) {
                    gradient.addColorStop(0, '#555');
                    gradient.addColorStop(0.5, '#666');
                    gradient.addColorStop(1, '#555');
                } else {
                    gradient.addColorStop(0, '#222');
                    gradient.addColorStop(0.5, '#333');
                    gradient.addColorStop(1, '#222');
                }
                
                this.ctx.fillStyle = gradient;
                this.ctx.fillRect(roadX, 0, roadWidth, this.canvas.height);
                
                this.ctx.strokeStyle = isLight ? '#ff6600' : '#00ff00';
                this.ctx.lineWidth = 3;
                this.ctx.beginPath();
                this.ctx.moveTo(roadX, 0);
                this.ctx.lineTo(roadX, this.canvas.height);
                this.ctx.moveTo(roadX + roadWidth, 0);
                this.ctx.lineTo(roadX + roadWidth, this.canvas.height);
                this.ctx.stroke();
                
                this.ctx.strokeStyle = isLight ? '#ff9900' : '#ffff00';
                this.ctx.lineWidth = 2;
                this.ctx.setLineDash([20, 20]);
                this.ctx.beginPath();
                this.ctx.moveTo(this.canvas.width / 2, 0);
                this.ctx.lineTo(this.canvas.width / 2, this.canvas.height);
                this.ctx.stroke();
                this.ctx.setLineDash([]);
                
                this.ctx.strokeStyle = isLight ? '#ffffff' : '#cccccc';
                this.ctx.lineWidth = 2;
                for (let i = -40; i < this.canvas.height; i += 40) {
                    const y = i + this.roadOffset;
                    if (y > 0) {
                        this.ctx.beginPath();
                        this.ctx.moveTo(roadX + 20, y);
                        this.ctx.lineTo(roadX + 20, y + 20);
                        this.ctx.stroke();
                        
                        this.ctx.beginPath();
                        this.ctx.moveTo(roadX + roadWidth - 20, y);
                        this.ctx.lineTo(roadX + roadWidth - 20, y + 20);
                        this.ctx.stroke();
                    }
                }
            }
            
            drawPlayerCar() {
                this.ctx.save();
                this.ctx.translate(
                    this.car.x + this.car.width / 2,
                    this.car.y + this.car.height / 2
                );
                this.ctx.rotate(this.car.rotation);
                
                const gradient = this.ctx.createLinearGradient(
                    -this.car.width / 2, -this.car.height / 2,
                    -this.car.width / 2, this.car.height / 2
                );
                gradient.addColorStop(0, '#ff0000');
                gradient.addColorStop(0.5, '#cc0000');
                gradient.addColorStop(1, '#990000');
                
                this.ctx.fillStyle = gradient;
                this.ctx.fillRect(-this.car.width / 2, -this.car.height / 2, this.car.width, this.car.height);
                
                this.ctx.fillStyle = document.body.classList.contains('light-mode') ? '#222' : '#111';
                this.ctx.fillRect(-this.car.width / 2 + 5, -this.car.height / 2 + 5, this.car.width - 10, 15);
                
                this.ctx.fillStyle = document.body.classList.contains('light-mode') ? '#666' : '#444';
                this.ctx.fillRect(-this.car.width / 2 + 8, -this.car.height / 2 + 25, this.car.width - 16, 20);
                
                this.ctx.fillStyle = '#ffff00';
                this.ctx.beginPath();
                this.ctx.ellipse(-this.car.width / 2 + 6, -this.car.height / 2 + 10, 5, 7, 0, 0, Math.PI * 2);
                this.ctx.fill();
                
                this.ctx.beginPath();
                this.ctx.ellipse(this.car.width / 2 - 6, -this.car.height / 2 + 10, 5, 7, 0, 0, Math.PI * 2);
                this.ctx.fill();
                
                this.ctx.fillStyle = '#ff0000';
                this.ctx.beginPath();
                this.ctx.ellipse(-this.car.width / 2 + 6, this.car.height / 2 - 10, 5, 7, 0, 0, Math.PI * 2);
                this.ctx.fill();
                
                this.ctx.beginPath();
                this.ctx.ellipse(this.car.width / 2 - 6, this.car.height / 2 - 10, 5, 7, 0, 0, Math.PI * 2);
                this.ctx.fill();
                
                this.drawWheel(-this.car.width / 2 + 8, -this.car.height / 2 + 10);
                this.drawWheel(this.car.width / 2 - 8, -this.car.height / 2 + 10);
                this.drawWheel(-this.car.width / 2 + 8, this.car.height / 2 - 10);
                this.drawWheel(this.car.width / 2 - 8, this.car.height / 2 - 10);
                
                this.ctx.restore();
            }
            
            drawWheel(x, y) {
                this.ctx.fillStyle = document.body.classList.contains('light-mode') ? '#111' : '#000';
                this.ctx.beginPath();
                this.ctx.ellipse(x, y, 6, 10, 0, 0, Math.PI * 2);
                this.ctx.fill();
                
                this.ctx.fillStyle = document.body.classList.contains('light-mode') ? '#333' : '#222';
                this.ctx.beginPath();
                this.ctx.arc(x, y, 4, 0, Math.PI * 2);
                this.ctx.fill();
            }
            
            drawObstacle(obs) {
                const gradient = this.ctx.createLinearGradient(obs.x, obs.y, obs.x, obs.y + obs.height);
                if (obs.color === '#ff6600') {
                    gradient.addColorStop(0, '#ff6600');
                    gradient.addColorStop(0.5, '#cc5500');
                    gradient.addColorStop(1, '#994400');
                } else {
                    gradient.addColorStop(0, '#ff0000');
                    gradient.addColorStop(0.5, '#cc0000');
                    gradient.addColorStop(1, '#990000');
                }
                
                this.ctx.fillStyle = gradient;
                this.ctx.fillRect(obs.x, obs.y, obs.width, obs.height);
                
                this.ctx.fillStyle = document.body.classList.contains('light-mode') ? '#222' : '#111';
                this.ctx.fillRect(obs.x + 5, obs.y + 5, obs.width - 10, 15);
                
                this.ctx.fillStyle = document.body.classList.contains('light-mode') ? '#666' : '#444';
                this.ctx.fillRect(obs.x + 8, obs.y + 25, obs.width - 16, 20);
                
                this.ctx.fillStyle = '#ffffff';
                this.ctx.beginPath();
                this.ctx.ellipse(obs.x + 6, obs.y + 10, 5, 7, 0, 0, Math.PI * 2);
                this.ctx.fill();
                
                this.ctx.beginPath();
                this.ctx.ellipse(obs.x + obs.width - 6, obs.y + 10, 5, 7, 0, 0, Math.PI * 2);
                this.ctx.fill();
                
                this.drawWheel(obs.x + 8, obs.y + 10);
                this.drawWheel(obs.x + obs.width - 8, obs.y + 10);
                this.drawWheel(obs.x + 8, obs.y + obs.height - 10);
                this.drawWheel(obs.x + obs.width - 8, obs.y + obs.height - 10);
            }
            
            drawPowerup(powerup) {
                this.ctx.shadowColor = powerup.color;
                this.ctx.shadowBlur = 15;
                
                this.ctx.fillStyle = powerup.color;
                this.ctx.beginPath();
                this.ctx.arc(
                    powerup.x + powerup.width / 2,
                    powerup.y + powerup.height / 2,
                    powerup.width / 2,
                    0, Math.PI * 2
                );
                this.ctx.fill();
                
                this.ctx.shadowBlur = 0;
                
                this.ctx.fillStyle = '#ffffff';
                this.ctx.font = 'bold 20px Arial';
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                this.ctx.fillText(
                    powerup.symbol,
                    powerup.x + powerup.width / 2,
                    powerup.y + powerup.height / 2
                );
            }
            
            drawShield() {
                this.ctx.save();
                this.ctx.translate(
                    this.car.x + this.car.width / 2,
                    this.car.y + this.car.height / 2
                );
                
                const pulse = Math.sin(Date.now() / 200) * 0.1 + 0.9;
                const radius = Math.max(this.car.width, this.car.height) / 2 * pulse + 10;
                
                this.ctx.strokeStyle = '#00ff00';
                this.ctx.lineWidth = 3;
                this.ctx.shadowColor = '#00ff00';
                this.ctx.shadowBlur = 20;
                this.ctx.globalAlpha = 0.6;
                
                this.ctx.beginPath();
                this.ctx.arc(0, 0, radius, 0, Math.PI * 2);
                this.ctx.stroke();
                
                this.ctx.globalAlpha = 1;
                this.ctx.shadowBlur = 0;
                this.ctx.restore();
            }
            
            drawNitroEffect() {
                const flameX = this.car.x + this.car.width / 2;
                const flameY = this.car.y + this.car.height;
                
                const flameGradient = this.ctx.createRadialGradient(
                    flameX, flameY + 20, 0,
                    flameX, flameY + 50, 25
                );
                flameGradient.addColorStop(0, '#ffff00');
                flameGradient.addColorStop(0.3, '#ff6600');
                flameGradient.addColorStop(1, 'transparent');
                
                this.ctx.fillStyle = flameGradient;
                this.ctx.beginPath();
                this.ctx.ellipse(flameX, flameY + 35, 20, 40, 0, 0, Math.PI * 2);
                this.ctx.fill();
            }
            
            drawParticles() {
                for (let p of this.particles) {
                    this.ctx.globalAlpha = p.life / 50;
                    this.ctx.fillStyle = p.color;
                    this.ctx.beginPath();
                    this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    this.ctx.fill();
                }
                this.ctx.globalAlpha = 1;
            }
            
            drawSparks() {
                for (let s of this.sparks) {
                    this.ctx.globalAlpha = s.life / 40;
                    this.ctx.fillStyle = s.color;
                    this.ctx.beginPath();
                    this.ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2);
                    this.ctx.fill();
                }
                this.ctx.globalAlpha = 1;
            }
        }

        // Initialize game when page loads
        window.addEventListener('load', () => {
            window.game = new ExtremeCarRacingGame();
        });
    </script>
</body>
</html>
